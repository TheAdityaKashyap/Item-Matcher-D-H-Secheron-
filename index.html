<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dayita - Item Matcher</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for reading Excel/CSV files -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .drag-active {
            border-color: #dc2626; /* Red-600 */
            background-color: #fef2f2; /* Red-50 */
        }
        /* Animation for analysis box */
        @keyframes slide-down {
            0% { opacity: 0; transform: translateY(-10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .analysis-box {
            animation: slide-down 0.3s ease-out forwards;
        }
        .ignored-term {
            text-decoration: line-through;
            color: #9ca3af; /* Gray-400 */
            opacity: 0.7;
        }
        .matched-term {
            color: #166534; /* Green-800 */
            background-color: #dcfce7; /* Green-100 */
            font-weight: 700;
            padding: 0 4px;
            border-radius: 4px;
        }
        /* Simple toast animation */
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .toast {
            animation: fade-in-out 2s forwards;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800 relative">

    <!-- Header (D&H Red Theme) -->
    <header class="bg-[#d32f2f] text-white shadow-md sticky top-0 z-10 border-b-4 border-gray-800">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-white p-1.5 rounded text-[#d32f2f]">
                    <i data-lucide="shield-check" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight uppercase">Dayita</h1>
                    <p class="text-xs text-red-100 font-medium tracking-wide">Item Matcher for D & H Secheron</p>
                </div>
            </div>
            <div class="text-sm opacity-90 hidden sm:block font-medium">Internal Inventory Tool</div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">

        <!-- File Upload Section -->
        <div id="upload-section" class="bg-white rounded-lg shadow-sm border-2 border-dashed border-gray-300 p-12 text-center transition-all duration-200 hover:border-red-300">
            <div class="flex flex-col items-center gap-5">
                <div class="p-5 bg-red-50 rounded-full text-[#d32f2f]">
                    <i data-lucide="file-spreadsheet" class="w-10 h-10"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-gray-800">Upload Master Inventory</h2>
                    <p class="text-gray-500 mt-2 max-w-md mx-auto">Drag and drop your <strong>.xlsx</strong> or <strong>.csv</strong> file here to begin searching.</p>
                </div>
                
                <input type="file" id="file-input" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="hidden" />
                
                <button onclick="document.getElementById('file-input').click()" class="mt-2 px-8 py-3 bg-[#d32f2f] hover:bg-red-700 text-white font-semibold rounded shadow-sm transition-colors uppercase text-sm tracking-wider">
                    Select File
                </button>
            </div>
        </div>

        <!-- Search & Data Section (Hidden initially) -->
        <div id="data-section" class="hidden space-y-6">
            
            <!-- Search Bar -->
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col items-start sticky top-24 z-20">
                <div class="flex flex-col md:flex-row gap-4 items-center w-full">
                    <div class="relative flex-grow w-full">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                        <input type="text" id="search-input" placeholder="Paste full query: e.g. '3.50 KG 715 Supratherme 3.20X350'" 
                            class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-300 rounded focus:ring-2 focus:ring-[#d32f2f] focus:border-[#d32f2f] outline-none transition-all placeholder-gray-500 text-gray-800"
                            autocomplete="off">
                    </div>
                    
                    <div class="flex items-center gap-3 w-full md:w-auto flex-wrap md:flex-nowrap">
                        <div class="px-4 py-2 bg-gray-100 rounded border border-gray-200 text-sm text-gray-600 font-semibold whitespace-nowrap">
                            <span id="result-count" class="text-[#d32f2f]">0</span> Matches
                        </div>
                        
                        <button onclick="downloadResults()" class="flex items-center gap-2 px-5 py-2.5 bg-gray-800 hover:bg-black text-white text-sm font-semibold rounded transition-colors whitespace-nowrap shadow-sm">
                            <i data-lucide="download" class="w-4 h-4"></i> Export Excel
                        </button>

                        <button onclick="resetApp()" class="px-5 py-2.5 text-[#d32f2f] border border-[#d32f2f] hover:bg-red-50 text-sm font-semibold rounded transition-colors whitespace-nowrap">
                            Reset
                        </button>
                    </div>
                </div>

                <!-- Query Analysis Box (Dynamic) -->
                <div id="analysis-container" class="w-full mt-4 hidden">
                    <div class="analysis-box bg-gray-50 border border-gray-200 rounded p-3 text-sm">
                        <div class="flex items-center gap-2 mb-1 text-xs font-bold text-gray-500 uppercase tracking-wide">
                            <i data-lucide="scan-line" class="w-3 h-3"></i> Query Analysis (Top Result Match)
                        </div>
                        <div id="query-feedback" class="text-base leading-relaxed">
                            <!-- Feedback injected here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Table -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-100 border-b border-gray-200">
                            <tr>
                                <th class="p-4 font-bold text-gray-700 text-sm w-16 text-center">Score</th>
                                <th class="p-4 font-bold text-gray-700 text-sm w-48 uppercase tracking-wider">Item Code</th>
                                <th class="p-4 font-bold text-gray-700 text-sm uppercase tracking-wider">Description</th>
                                <th class="p-4 font-bold text-gray-700 text-sm w-32 uppercase tracking-wider">Location</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-gray-100 text-sm text-gray-700">
                            <!-- Rows injected here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Empty State -->
                <div id="empty-state" class="hidden p-16 text-center text-gray-500">
                    <i data-lucide="package-search" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                    <p class="text-lg font-medium">No inventory items found.</p>
                    <p class="text-sm">Try adjusting your search terms.</p>
                </div>
            </div>
        </div>

    </main>
    
    <!-- Copy Toast Notification -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 pointer-events-none"></div>

    <!-- Footer -->
    <footer class="text-center py-6 text-xs text-gray-400">
        &copy; <span id="year"></span> Dayita Inventory System. Designed for D & H Secheron.
    </footer>

    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        // --- State Management ---
        let inventoryData = [];
        let filteredData = []; // Store currently visible data for export
        const uploadSection = document.getElementById('upload-section');
        const dataSection = document.getElementById('data-section');
        const fileInput = document.getElementById('file-input');
        const searchInput = document.getElementById('search-input');
        const tableBody = document.getElementById('table-body');
        const resultCount = document.getElementById('result-count');
        const emptyState = document.getElementById('empty-state');
        const toastContainer = document.getElementById('toast-container');
        const analysisContainer = document.getElementById('analysis-container');
        const queryFeedback = document.getElementById('query-feedback');

        // --- Icon Setup ---
        lucide.createIcons();

        // --- Event Listeners ---
        
        // Drag & Drop
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('drag-active');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('drag-active');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('drag-active');
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });

        // Search Input
        searchInput.addEventListener('input', (e) => {
            renderTable(e.target.value);
        });

        // --- Core Functions ---

        // Helper: Extract ALL potential weights from a text string
        function extractWeightsFromText(str) {
            if (!str) return [];
            const weights = [];
            const regexWithUnits = /(\d+(\.\d+)?)\s*(?:kgs?|kg|lbs?)\b/gi;
            let match;
            while ((match = regexWithUnits.exec(str)) !== null) {
                weights.push(parseFloat(match[1]));
            }
            return weights;
        }
        
        // Helper: Parse search term to see if it's a weight query
        function parseSearchTermWeight(term) {
            const weightMatch = term.match(/^(\d+(\.\d+)?)[kK]?[gG]?[sS]?\.?$/);
            if (weightMatch) {
                return parseFloat(weightMatch[1]);
            }
            return null;
        }

        // Helper: Normalize string
        const normalize = (str) => str.toLowerCase().replace(/[^a-z0-9.]/g, "");

        function handleFile(file) {
            const reader = new FileReader();

            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                if (jsonData.length > 0) {
                    inventoryData = jsonData.map(item => ({
                        ...item,
                        _extractedWeights: extractWeightsFromText(item['Description'])
                    }));
                    
                    filteredData = inventoryData;
                    showDataUI();
                    renderTable();
                } else {
                    alert("The file appears to be empty or unreadable.");
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function showDataUI() {
            uploadSection.classList.add('hidden');
            dataSection.classList.remove('hidden');
            searchInput.focus();
        }

        function resetApp() {
            inventoryData = [];
            filteredData = [];
            fileInput.value = '';
            searchInput.value = '';
            uploadSection.classList.remove('hidden');
            dataSection.classList.add('hidden');
            analysisContainer.classList.add('hidden');
        }

        function renderTable(searchTerm = "") {
            tableBody.innerHTML = "";
            const rawTerms = searchTerm.toLowerCase().split(/[\s,]+/).filter(t => t.length > 0); 
            
            if (rawTerms.length === 0) {
                filteredData = inventoryData;
                analysisContainer.classList.add('hidden');
            } else {
                // Scoring Logic
                const scoredData = inventoryData.map(item => {
                    let score = 0;
                    const description = (item['Description'] || '').toLowerCase();
                    const itemCode = (item['Item Code'] || '').toLowerCase();
                    const location = (item['Location'] || '').toLowerCase();
                    
                    const originalString = `${itemCode} ${description} ${location}`;
                    const smartString = normalize(originalString);

                    rawTerms.forEach(term => {
                        const cleanTerm = normalize(term);
                        const termWeight = parseSearchTermWeight(term);

                        if (originalString.includes(term)) {
                            score += 2; 
                        } else if (cleanTerm.length > 0 && smartString.includes(cleanTerm)) {
                            score += 1; 
                        }

                        if (termWeight !== null && item._extractedWeights.length > 0) {
                            const matchFound = item._extractedWeights.some(w => Math.abs(w - termWeight) < 0.05);
                            if (matchFound) {
                                score += 3;
                            }
                        }
                    });

                    return { ...item, _score: score };
                });

                filteredData = scoredData.filter(item => item._score > 0);
                filteredData.sort((a, b) => b._score - a._score);
                
                // --- Update Query Analysis ---
                updateQueryAnalysis(rawTerms, filteredData[0]);
            }

            resultCount.textContent = filteredData.length;

            if (filteredData.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            } else {
                emptyState.classList.add('hidden');
            }

            const displayLimit = 100;
            
            filteredData.slice(0, displayLimit).forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-red-50 transition-colors group border-b border-gray-100 last:border-0";
                
                const itemCode = item['Item Code'] || '-';
                const score = item._score ? `<span class="bg-red-100 text-[#d32f2f] px-2 py-0.5 rounded-full text-xs font-bold">${item._score}</span>` : '-';
                
                tr.innerHTML = `
                    <td class="p-4 text-center">${score}</td>
                    <td class="p-4">
                        <div class="flex items-center gap-2">
                            <span class="font-mono text-xs font-bold text-[#d32f2f] bg-red-50 px-2 py-1 rounded">${itemCode}</span>
                            <button onclick="copyToClipboard('${itemCode}')" class="opacity-0 group-hover:opacity-100 transition-opacity text-gray-400 hover:text-[#d32f2f] p-1" title="Copy Item Code">
                                <i data-lucide="copy" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </td>
                    <td class="p-4 font-medium text-gray-800">${item['Description'] || '-'}</td>
                    <td class="p-4">
                        <span class="inline-flex items-center px-2.5 py-1 rounded text-xs font-bold bg-gray-200 text-gray-700">
                            ${item['Location'] || '-'}
                        </span>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
            lucide.createIcons();
        }

        // --- NEW: Query Analysis Function ---
        function updateQueryAnalysis(terms, topResult) {
            if (!topResult) {
                analysisContainer.classList.add('hidden');
                return;
            }

            analysisContainer.classList.remove('hidden');
            
            const description = (topResult['Description'] || '').toLowerCase();
            const itemCode = (topResult['Item Code'] || '').toLowerCase();
            const location = (topResult['Location'] || '').toLowerCase();
            const fullTargetString = normalize(`${itemCode} ${description} ${location}`);
            const targetWeights = topResult._extractedWeights || [];

            let html = "";

            terms.forEach(term => {
                const cleanTerm = normalize(term);
                const termWeight = parseSearchTermWeight(term);
                let isMatch = false;

                // Check text match
                if (cleanTerm.length > 0 && fullTargetString.includes(cleanTerm)) {
                    isMatch = true;
                }
                
                // Check weight match
                if (!isMatch && termWeight !== null) {
                    if (targetWeights.some(w => Math.abs(w - termWeight) < 0.05)) {
                        isMatch = true;
                    }
                }

                if (isMatch) {
                    html += `<span class="matched-term mx-1">${term}</span>`;
                } else {
                    html += `<span class="ignored-term mx-1">${term}</span>`;
                }
            });

            queryFeedback.innerHTML = html;
        }

        // --- Export Feature ---
        function downloadResults() {
            if (filteredData.length === 0) {
                alert("No data to export!");
                return;
            }
            const cleanData = filteredData.map(item => ({
                "Item Code": item['Item Code'],
                "Description": item['Description'],
                "Location": item['Location']
            }));
            
            const worksheet = XLSX.utils.json_to_sheet(cleanData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "SearchResults");
            XLSX.writeFile(workbook, "Dayita_SearchResults.xlsx");
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast(`Copied: ${text}`);
            });
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = "toast bg-gray-900 text-white px-5 py-3 rounded shadow-xl text-sm mb-2 flex items-center gap-2 border-l-4 border-[#d32f2f]";
            toast.innerHTML = `<i data-lucide="check" class="w-4 h-4 text-green-400"></i> ${message}`;
            toastContainer.appendChild(toast);
            lucide.createIcons();
            
            setTimeout(() => {
                toast.remove();
            }, 2000);
        }
    </script>
</body>
</html>