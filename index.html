<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dayita - Enterprise Inventory</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#111827',
                            surface: '#1f2937',
                            border: '#374151',
                            text: '#f3f4f6',
                            muted: '#9ca3af'
                        }
                    }
                }
            }
        }
    </script>
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- IMPORTANT: Use type="text/tailwindcss" for @apply to work in CDN -->
    <style type="text/tailwindcss">
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');

        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark .custom-scroll::-webkit-scrollbar-thumb { background-color: #4b5563; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        .loader { border: 2px solid #f3f3f3; border-top: 2px solid #dc2626; border-radius: 50%; width: 16px; height: 16px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Checkbox */
        .checkbox-wrapper input:checked + div {
            background-color: #dc2626;
            border-color: #dc2626;
        }
        .checkbox-wrapper input:checked + div svg {
            opacity: 1;
        }

        /* Analysis Badges - Enhanced Colors */
        .badge-base { @apply px-2.5 py-1 rounded-md text-[11px] font-bold uppercase tracking-wide mr-1.5 mb-1 inline-flex items-center gap-1 shadow-sm border; }
        
        /* Green for Matches (Text) */
        .badge-match { @apply bg-green-100 text-green-800 border-green-200 dark:bg-green-500/20 dark:text-green-300 dark:border-green-500/30; }
        
        /* Blue for Dimensions */
        .badge-dim   { @apply bg-blue-100 text-blue-800 border-blue-200 dark:bg-blue-500/20 dark:text-blue-300 dark:border-blue-500/30; }
        
        /* Purple for Weight */
        .badge-weight{ @apply bg-purple-100 text-purple-800 border-purple-200 dark:bg-purple-500/20 dark:text-purple-300 dark:border-purple-500/30; }
        
        /* Orange for Packing */
        .badge-pack  { @apply bg-orange-100 text-orange-800 border-orange-200 dark:bg-orange-500/20 dark:text-orange-300 dark:border-orange-500/30; }
        
        /* Teal for Export */
        .badge-exp   { @apply bg-teal-100 text-teal-800 border-teal-200 dark:bg-teal-500/20 dark:text-teal-300 dark:border-teal-500/30; }
        
        /* Gray for Ignored */
        .badge-skip  { @apply bg-gray-100 text-gray-400 border-gray-200 line-through decoration-gray-400 dark:bg-gray-800 dark:text-gray-500 dark:border-gray-700; }
        
        /* Indigo for Compressed Code Match */
        .badge-comp  { @apply bg-indigo-100 text-indigo-800 border-indigo-200 dark:bg-indigo-500/20 dark:text-indigo-300 dark:border-indigo-500/30; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-gray-50 text-slate-800 dark:bg-dark-bg dark:text-dark-text transition-colors duration-200">

    <!-- Navbar -->
    <header class="bg-white dark:bg-dark-surface border-b border-gray-200 dark:border-dark-border z-30 shrink-0 transition-colors">
        <div class="px-6 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-[#d32f2f] p-1.5 rounded-lg shadow-sm text-white">
                    <i data-lucide="shield-check" class="w-5 h-5"></i>
                </div>
                <div class="leading-tight">
                    <h1 class="text-lg font-bold tracking-tight text-gray-900 dark:text-white uppercase">Dayita</h1>
                    <p class="text-[10px] text-gray-500 dark:text-gray-400 font-semibold tracking-wider uppercase">Enterprise Inventory System</p>
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Theme Toggle -->
                <button onclick="toggleTheme()" class="p-2 text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors" title="Toggle Dark Mode">
                    <i data-lucide="moon" class="w-5 h-5 block dark:hidden"></i>
                    <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
                </button>

                <div id="file-status" class="hidden flex items-center gap-2 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-3 py-1.5 rounded-full text-xs font-medium border border-green-200 dark:border-green-800/50 shadow-sm transition-all">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    <span id="item-count-display">0 Items Ready</span>
                </div>
                <button onclick="clearAllData()" class="p-2 text-gray-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors" title="Reset Database">
                    <i data-lucide="power" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="w-72 bg-white dark:bg-dark-surface border-r border-gray-200 dark:border-dark-border flex flex-col z-20 hidden shadow-[4px_0_24px_-12px_rgba(0,0,0,0.1)] transition-colors" id="sidebar">
            <div class="p-5 border-b border-gray-100 dark:border-dark-border flex justify-between items-center bg-gray-50/50 dark:bg-gray-800/50">
                <span class="text-xs font-bold text-gray-400 dark:text-gray-500 uppercase tracking-wider flex items-center gap-2">
                    <i data-lucide="filter" class="w-3 h-3"></i> Smart Filters
                </span>
                <button onclick="resetFilters()" class="text-xs text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-medium hover:underline decoration-red-200 underline-offset-2">Clear All</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-2 custom-scroll" id="filters-container">
                <div class="text-center mt-10 text-gray-400 text-sm flex flex-col items-center">
                    <i data-lucide="filter-x" class="w-8 h-8 mb-2 opacity-50"></i>
                    No filters available
                </div>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="flex-1 flex flex-col bg-gray-50/50 dark:bg-dark-bg relative overflow-hidden transition-colors">
            
            <!-- Upload Overlay -->
            <div id="upload-overlay" class="absolute inset-0 z-40 bg-gray-50/90 dark:bg-dark-bg/90 flex flex-col items-center justify-center p-6 backdrop-blur-sm">
                <div id="drop-zone" class="bg-white dark:bg-dark-surface w-full max-w-lg rounded-2xl shadow-xl border-2 border-dashed border-gray-200 dark:border-dark-border p-12 text-center transition-all duration-300 hover:border-red-400 dark:hover:border-red-500/50 hover:shadow-2xl hover:-translate-y-1">
                    <div class="mx-auto w-16 h-16 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 rounded-2xl flex items-center justify-center mb-6 shadow-inner">
                        <i data-lucide="database" class="w-8 h-8"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Initialize Master Data</h2>
                    <p class="text-gray-500 dark:text-gray-400 mb-8 text-sm leading-relaxed">Upload your <strong>Master Inventory</strong> file (.xlsx)<br>to configure the Dayita engine.</p>
                    <button onclick="document.getElementById('file-input').click()" class="bg-[#d32f2f] hover:bg-red-700 text-white px-8 py-3 rounded-xl font-medium transition-all shadow-lg shadow-red-200 dark:shadow-none active:scale-95 flex items-center gap-2 mx-auto">
                        <i data-lucide="folder-open" class="w-4 h-4"></i>
                        Load Master File
                    </button>
                    <input type="file" id="file-input" accept=".xlsx,.xls,.csv" class="hidden" />
                </div>
            </div>

            <!-- Application View -->
            <div id="app-view" class="flex flex-col h-full w-full hidden animate-fade-in">
                
                <!-- Tab Navigation -->
                <div class="bg-white dark:bg-dark-surface border-b border-gray-200 dark:border-dark-border px-6 pt-4 flex gap-6 shrink-0 shadow-sm z-10 transition-colors">
                    <button onclick="switchTab('search')" id="tab-btn-search" class="pb-3 text-sm font-medium flex items-center gap-2 border-b-2 border-transparent transition-all hover:text-red-600 dark:hover:text-red-400 text-gray-500 dark:text-gray-400">
                        <i data-lucide="search" class="w-4 h-4"></i> Interactive Search
                    </button>
                    <button onclick="switchTab('bulk')" id="tab-btn-bulk" class="pb-3 text-sm font-medium flex items-center gap-2 border-b-2 border-transparent transition-all hover:text-red-600 dark:hover:text-red-400 text-gray-500 dark:text-gray-400">
                        <i data-lucide="layers" class="w-4 h-4"></i> Bulk Processing
                    </button>
                </div>

                <!-- Interactive Search Tab -->
                <div id="tab-search" class="flex-1 flex flex-col overflow-hidden p-6 gap-6 max-w-7xl mx-auto w-full">
                    
                    <!-- Search Header Container -->
                    <div class="flex flex-col gap-2">
                        <!-- Search Bar -->
                        <div class="bg-white dark:bg-dark-surface p-1.5 rounded-xl shadow-sm border border-gray-200 dark:border-dark-border flex items-center focus-within:ring-2 focus-within:ring-red-100 dark:focus-within:ring-red-900/30 focus-within:border-red-400 transition-all">
                            <div class="pl-4 pr-3 text-gray-400">
                                <i data-lucide="search" class="w-5 h-5"></i>
                            </div>
                            <input type="text" id="search-input" placeholder="Type query... (e.g. '5.0 KG F70S6 1.60X1000')" 
                                class="flex-1 outline-none text-gray-700 dark:text-gray-200 py-2.5 text-base bg-transparent placeholder-gray-400" autocomplete="off">
                            <div class="h-8 w-px bg-gray-200 dark:bg-dark-border mx-2"></div>
                            <div class="pr-4 flex items-center gap-2">
                                <span class="text-xs font-semibold text-gray-400 uppercase">Matches</span>
                                <span id="search-count" class="text-sm font-bold text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 px-2 py-0.5 rounded-md min-w-[30px] text-center">0</span>
                            </div>
                        </div>

                        <!-- Analysis Bar -->
                        <div id="analysis-bar" class="hidden bg-white dark:bg-dark-surface border border-gray-200 dark:border-dark-border rounded-lg p-2.5 flex items-center gap-2 shadow-sm animate-fade-in min-h-[44px]">
                            <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-2 border-r border-gray-100 dark:border-dark-border self-center">Analysis</span>
                            <div id="analysis-content" class="flex flex-wrap gap-1 text-xs items-center">
                                <!-- Pills go here -->
                            </div>
                        </div>
                    </div>

                    <!-- Results Table -->
                    <div class="flex-1 bg-white dark:bg-dark-surface rounded-xl shadow-[0_2px_8px_rgba(0,0,0,0.04)] border border-gray-200 dark:border-dark-border overflow-hidden flex flex-col transition-colors">
                        <div class="overflow-y-auto flex-1 custom-scroll">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-gray-50/80 dark:bg-gray-800/80 border-b border-gray-200 dark:border-dark-border sticky top-0 z-10 backdrop-blur-sm">
                                    <tr>
                                        <th class="p-4 text-[11px] font-bold text-gray-400 uppercase tracking-wider w-20 text-center">Score</th>
                                        <th class="p-4 text-[11px] font-bold text-gray-400 uppercase tracking-wider w-48">Item Code</th>
                                        <th class="p-4 text-[11px] font-bold text-gray-400 uppercase tracking-wider">Description</th>
                                        <th class="p-4 text-[11px] font-bold text-gray-400 uppercase tracking-wider w-36">Location</th>
                                        <th class="p-4 text-[11px] font-bold text-gray-400 uppercase tracking-wider w-20 text-center">Copy</th>
                                    </tr>
                                </thead>
                                <tbody id="search-table-body" class="divide-y divide-gray-50 dark:divide-gray-800 text-sm">
                                    <!-- Rows -->
                                </tbody>
                            </table>
                            
                            <!-- Empty State -->
                            <div id="search-empty" class="h-full flex flex-col items-center justify-center text-gray-400 pb-10">
                                <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-full mb-4 transition-colors">
                                    <i data-lucide="search-x" class="w-8 h-8 opacity-40"></i>
                                </div>
                                <p class="font-medium text-gray-500 dark:text-gray-400">No matches found</p>
                                <p class="text-xs opacity-60 mt-1">Try adjusting your filters or search terms</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Matcher Tab -->
                <div id="tab-bulk" class="flex-1 flex flex-col overflow-hidden p-6 gap-6 hidden max-w-7xl mx-auto w-full">
                    <div class="flex gap-6 h-full items-stretch">
                        
                        <!-- Input Section -->
                        <div class="w-1/3 flex flex-col gap-0 shadow-sm rounded-xl overflow-hidden border border-gray-200 dark:border-dark-border bg-white dark:bg-dark-surface transition-colors">
                            <div class="bg-gray-50/50 dark:bg-gray-800/50 p-4 border-b border-gray-200 dark:border-dark-border flex justify-between items-center">
                                <h3 class="font-bold text-gray-700 dark:text-gray-300 text-xs uppercase tracking-wide flex items-center gap-2">
                                    <i data-lucide="clipboard-list" class="w-4 h-4 text-gray-400"></i> Query Data
                                </h3>
                                <button onclick="document.getElementById('bulk-file-input').click()" class="text-blue-600 dark:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/30 px-3 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center gap-1.5">
                                    <i data-lucide="upload" class="w-3 h-3"></i> Upload File
                                </button>
                                <input type="file" id="bulk-file-input" accept=".xlsx,.xls,.csv" class="hidden" />
                            </div>
                            
                            <!-- Drop Zone for Query File -->
                            <div id="bulk-drop-zone" class="flex-1 relative flex flex-col">
                                <textarea id="bulk-input" class="absolute inset-0 w-full h-full p-5 resize-none outline-none text-xs font-mono leading-relaxed text-gray-600 dark:text-gray-300 bg-transparent placeholder-gray-300 dark:placeholder-gray-600 focus:bg-gray-50/30 dark:focus:bg-gray-800/30 transition-colors z-10" 
                                    placeholder="Paste lines here OR Drop your Order File...&#10;&#10;04 X 3.50 KG Supratherme 3.20X350 VP&#10;Secheron 308L 4.00mm REG"></textarea>
                                
                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 transition-opacity bg-white/90 dark:bg-dark-surface/90 backdrop-blur-sm z-20" id="bulk-drop-overlay">
                                    <div class="text-center text-blue-500">
                                        <i data-lucide="file-plus" class="w-10 h-10 mx-auto mb-2"></i>
                                        <p class="font-bold">Drop Query File</p>
                                    </div>
                                </div>
                            </div>

                            <div class="p-4 border-t border-gray-200 dark:border-dark-border bg-gray-50/30 dark:bg-gray-800/30 flex justify-end">
                                <button onclick="processBulk()" class="bg-gray-900 dark:bg-white dark:text-gray-900 hover:bg-black dark:hover:bg-gray-200 text-white px-5 py-2 rounded-lg text-xs font-bold transition-all shadow-md hover:shadow-lg flex items-center gap-2 group w-full justify-center">
                                    <span id="bulk-btn-text">Start Matching</span>
                                    <i data-lucide="play" class="w-3 h-3 group-hover:text-green-400 dark:group-hover:text-green-600 transition-colors" id="play-icon"></i>
                                    <div id="bulk-loader" class="loader hidden"></div>
                                </button>
                            </div>
                        </div>

                        <!-- Output Section -->
                        <div class="w-2/3 flex flex-col gap-0 shadow-sm rounded-xl overflow-hidden border border-gray-200 dark:border-dark-border bg-white dark:bg-dark-surface transition-colors">
                             <div class="bg-gray-50/50 dark:bg-gray-800/50 p-4 border-b border-gray-200 dark:border-dark-border flex justify-between items-center">
                                <h3 class="font-bold text-gray-700 dark:text-gray-300 text-xs uppercase tracking-wide flex items-center gap-2">
                                    <i data-lucide="table-2" class="w-4 h-4 text-gray-400"></i> Results
                                </h3>
                                <button onclick="exportBulk()" class="text-gray-600 dark:text-gray-400 hover:text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 px-3 py-1.5 rounded-lg text-xs font-bold transition-all flex items-center gap-2 border border-gray-200 dark:border-dark-border hover:border-green-200 bg-white dark:bg-dark-surface shadow-sm">
                                    <i data-lucide="file-spreadsheet" class="w-3 h-3"></i> Export Report
                                </button>
                            </div>
                            <div class="flex-1 overflow-y-auto custom-scroll relative bg-white dark:bg-dark-surface">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-gray-50 dark:bg-gray-800 border-b border-gray-200 dark:border-dark-border sticky top-0 z-10 backdrop-blur-sm">
                                        <tr>
                                            <th class="p-3 text-[10px] font-bold text-gray-400 uppercase w-1/3 pl-5">Original Query</th>
                                            <th class="p-3 text-[10px] font-bold text-gray-400 uppercase w-28">Matched Code</th>
                                            <th class="p-3 text-[10px] font-bold text-gray-400 uppercase">Matched Description</th>
                                            <th class="p-3 text-[10px] font-bold text-gray-400 uppercase w-16 text-center">Conf.</th>
                                        </tr>
                                    </thead>
                                    <tbody id="bulk-table-body" class="divide-y divide-gray-50 dark:divide-gray-800 text-xs">
                                        <!-- Rows -->
                                    </tbody>
                                </table>
                                <div id="bulk-empty" class="absolute inset-0 flex items-center justify-center text-gray-300 dark:text-gray-600 pointer-events-none">
                                    <p>Results will appear here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-8 right-8 bg-gray-900 dark:bg-white text-white dark:text-gray-900 px-5 py-3 rounded-xl shadow-2xl text-sm font-medium transform translate-y-32 transition-all duration-300 z-50 flex items-center gap-3 border border-gray-800 dark:border-gray-200">
        <i data-lucide="check-circle-2" class="w-5 h-5 text-green-400 dark:text-green-600"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <script>
        // --- Global State ---
        let inventoryData = [];
        let filteredInventory = [];
        let bulkResults = [];
        let activeFilters = { diameters: new Set(), locations: new Set(), packings: new Set() };

        // --- Core Functions ---
        
        window.addEventListener('load', () => {
            lucide.createIcons();
            loadData();
            // Check system preference for theme
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Toggle Theme
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
        }

        // --- MASTER FILE UPLOAD ---
        const fileInput = document.getElementById('file-input');
        fileInput.addEventListener('change', e => {
            if(e.target.files.length) handleFile(e.target.files[0]);
        });

        const dropZone = document.getElementById('drop-zone');
        dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('border-red-400', 'bg-red-50', 'dark:bg-red-900/20', 'scale-[1.02]'); });
        dropZone.addEventListener('dragleave', e => { e.preventDefault(); dropZone.classList.remove('border-red-400', 'bg-red-50', 'dark:bg-red-900/20', 'scale-[1.02]'); });
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('border-red-400', 'bg-red-50', 'dark:bg-red-900/20', 'scale-[1.02]');
            if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = e => {
                const workbook = XLSX.read(e.target.result, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { defval: "" });
                processInventory(json);
            };
            reader.readAsArrayBuffer(file);
        }

        function processInventory(json) {
            if(!json || json.length === 0) return alert("Empty file");
            
            inventoryData = json.map(item => {
                const desc = (item['Description'] || "").trim();
                const code = (item['Item Code'] || "").trim();
                const loc = (item['Location'] || "").trim();
                
                const brand = desc.split(' ')[0].toUpperCase().replace(/[^A-Z0-9]/g, "");
                const dims = extractDimensions(desc);
                const diameter = dims.find(d => d.type === 'single' || d.type === 'rod')?.d1 || null;
                const weights = extractWeights(desc);
                const packings = extractPacking(desc);
                const isExp = desc.toUpperCase().includes("(EXP)");
                
                // NEW: Create a compressed search string (remove spaces) for code matching
                const compressedStr = normalize(`${code} ${desc} ${loc}`).replace(/\s/g, '');

                return {
                    ...item,
                    _searchStr: normalize(`${code} ${desc} ${loc}`),
                    _compressedStr: compressedStr,
                    _brand: brand,
                    _diameter: diameter ? diameter.toFixed(2) : "Other",
                    _location: loc || "Unknown",
                    _dims: dims,
                    _weights: weights,
                    _packings: packings,
                    _isExp: isExp
                };
            });

            saveData();
            initApp();
        }

        function saveData() {
            try {
                localStorage.setItem('dayita_db', JSON.stringify(inventoryData));
                showToast("Database Updated Successfully");
            } catch(e) { showToast("File too large. Session mode only."); }
        }

        function loadData() {
            const saved = localStorage.getItem('dayita_db');
            if(saved) {
                inventoryData = JSON.parse(saved);
                initApp();
            }
        }

        function clearAllData() {
            if(confirm("Factory Reset: Clear all data?")) {
                localStorage.removeItem('dayita_db');
                location.reload();
            }
        }

        function initApp() {
            if(inventoryData.length === 0) return;
            
            document.getElementById('upload-overlay').classList.add('hidden');
            document.getElementById('app-view').classList.remove('hidden');
            document.getElementById('sidebar').classList.remove('hidden');
            
            document.getElementById('item-count-display').textContent = `${inventoryData.length.toLocaleString()} Items`;
            document.getElementById('file-status').classList.remove('hidden');
            
            generateFilters();
            applyFilters();
            
            switchTab('search');
        }

        // --- QUERY FILE UPLOAD (FOR BULK) ---
        const bulkFileInput = document.getElementById('bulk-file-input');
        bulkFileInput.addEventListener('change', e => {
            if(e.target.files.length) handleBulkFile(e.target.files[0]);
        });

        // Drag Drop for Bulk
        const bulkDropZone = document.getElementById('bulk-drop-zone');
        const bulkOverlay = document.getElementById('bulk-drop-overlay');
        
        bulkDropZone.addEventListener('dragover', e => { e.preventDefault(); bulkOverlay.classList.remove('opacity-0'); });
        bulkDropZone.addEventListener('dragleave', e => { e.preventDefault(); bulkOverlay.classList.add('opacity-0'); });
        bulkDropZone.addEventListener('drop', e => {
            e.preventDefault();
            bulkOverlay.classList.add('opacity-0');
            if(e.dataTransfer.files.length) handleBulkFile(e.dataTransfer.files[0]);
        });

        function handleBulkFile(file) {
            const reader = new FileReader();
            reader.onload = e => {
                const workbook = XLSX.read(e.target.result, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 1 }); 
                
                const lines = json.map(row => row.join(" ")).join("\n");
                document.getElementById('bulk-input').value = lines;
                showToast("Query File Loaded");
            };
            reader.readAsArrayBuffer(file);
        }

        // --- Filter System ---
        function generateFilters() {
            const counts = { diameters: {}, locations: {}, packings: {} };
            
            inventoryData.forEach(item => {
                if(item._diameter) counts.diameters[item._diameter] = (counts.diameters[item._diameter] || 0) + 1;
                if(item._location) counts.locations[item._location] = (counts.locations[item._location] || 0) + 1;
                
                // Packing
                item._packings.forEach(p => {
                    const label = p.toUpperCase();
                    counts.packings[label] = (counts.packings[label] || 0) + 1;
                });
            });

            const container = document.getElementById('filters-container');
            container.innerHTML = ""; // Clear existing

            // Updated Filter Order
            renderFilterSection('Diameter', counts.diameters, 'diameters');
            renderFilterSection('Packing Type', counts.packings, 'packings');
            renderFilterSection('Location', counts.locations, 'locations');
        }

        function renderFilterSection(title, data, type) {
            const container = document.getElementById('filters-container');
            let keys = Object.keys(data);
            if(type === 'diameters') keys.sort((a,b) => parseFloat(a) - parseFloat(b));
            else keys.sort();

            const sectionId = `filter-${type}`;
            const iconId = `icon-${type}`;

            let html = `
                <div class="border-b border-gray-100 dark:border-gray-700 last:border-0">
                    <button onclick="toggleSection('${type}')" class="w-full py-3 px-1 flex items-center justify-between group focus:outline-none">
                        <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest group-hover:text-red-500 transition-colors">${title}</span>
                        <i data-lucide="chevron-down" id="${iconId}" class="w-3 h-3 text-gray-400 transition-transform"></i>
                    </button>
                    <div id="${sectionId}" class="hidden pb-4 space-y-0.5 animate-fade-in">
            `;
            
            keys.forEach(key => {
                if(!key || key === 'undefined') return;
                html += `
                    <label class="flex items-center gap-3 cursor-pointer group p-1.5 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors checkbox-wrapper">
                        <input type="checkbox" class="hidden" onchange="toggleFilter('${type}', '${key}')">
                        <div class="w-4 h-4 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 flex items-center justify-center transition-all group-hover:border-red-300 shadow-sm">
                            <i data-lucide="check" class="w-3 h-3 text-white opacity-0 transition-opacity"></i>
                        </div>
                        <span class="text-xs text-gray-600 dark:text-gray-300 flex-1 truncate font-medium group-hover:text-gray-900 dark:group-hover:text-white">${key}</span>
                        <span class="text-[9px] bg-gray-100 dark:bg-gray-700 text-gray-400 dark:text-gray-500 px-1.5 py-0.5 rounded-full font-mono group-hover:bg-gray-200 dark:group-hover:bg-gray-600">${data[key]}</span>
                    </label>
                `;
            });
            html += `</div></div>`;
            
            const wrapper = document.createElement('div');
            wrapper.innerHTML = html;
            container.appendChild(wrapper);
            lucide.createIcons();
        }

        function toggleSection(type) {
            const section = document.getElementById(`filter-${type}`);
            const icon = document.getElementById(`icon-${type}`);
            section.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        }

        function toggleFilter(type, value) {
            const set = activeFilters[type];
            if(set.has(value)) set.delete(value); else set.add(value);
            applyFilters();
        }

        function resetFilters() {
            activeFilters = { diameters: new Set(), locations: new Set(), packings: new Set() };
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            applyFilters();
        }

        function applyFilters() {
            filteredInventory = inventoryData.filter(item => {
                // Diameter
                if(activeFilters.diameters.size > 0 && !activeFilters.diameters.has(item._diameter)) return false;
                
                // Location
                if(activeFilters.locations.size > 0 && !activeFilters.locations.has(item._location)) return false;
                
                // Packing
                if(activeFilters.packings.size > 0) {
                    // Item must have AT LEAST ONE of the selected packings
                    // Map item packings to UpperCase for comparison
                    const itemPacks = item._packings.map(p => p.toUpperCase());
                    const hasMatch = itemPacks.some(p => activeFilters.packings.has(p));
                    if(!hasMatch) return false;
                }

                return true;
            });
            runSearch(document.getElementById('search-input').value);
        }

        // --- Search System ---
        document.getElementById('search-input').addEventListener('input', e => runSearch(e.target.value));

        function runSearch(query) {
            const tbody = document.getElementById('search-table-body');
            const empty = document.getElementById('search-empty');
            const count = document.getElementById('search-count');
            const analysisBar = document.getElementById('analysis-bar');
            
            tbody.innerHTML = '';
            
            const queryInfo = parseQuery(query);
            let results = [];

            if (!queryInfo.hasTerms) {
                results = filteredInventory.map(item => ({ item, score: 0 }));
                analysisBar.classList.add('hidden'); 
            } else {
                results = filteredInventory.map(item => ({ 
                    item, 
                    score: calculateScore(item, queryInfo) 
                })).filter(r => r.score > 0).sort((a,b) => b.score - a.score);
                
                // Update Analysis Bar
                updateAnalysisUI(queryInfo, results[0]?.item);
            }

            count.textContent = results.length.toLocaleString();
            
            if(results.length === 0) {
                empty.classList.remove('hidden');
                if(queryInfo.hasTerms) updateAnalysisUI(queryInfo, null); 
            } else {
                empty.classList.add('hidden');
                results.slice(0, 50).forEach(({ item, score }) => {
                    const row = document.createElement('tr');
                    row.className = 'group hover:bg-red-50/50 dark:hover:bg-red-900/10 transition-colors border-b border-gray-50 dark:border-gray-800';
                    
                    const scoreColor = score > 30 ? 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400' : (score > 15 ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400' : 'bg-gray-100 text-gray-500 dark:bg-gray-800 dark:text-gray-400');
                    
                    row.innerHTML = `
                        <td class="p-3 text-center">
                            <span class="${scoreColor} font-bold px-2 py-0.5 rounded text-[10px] font-mono">${score > 0 ? score : '-'}</span>
                        </td>
                        <td class="p-3">
                            <span class="font-mono text-xs font-semibold text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 px-2 py-1 rounded-md shadow-sm group-hover:border-red-200 dark:group-hover:border-red-800 group-hover:text-red-700 dark:group-hover:text-red-400 transition-colors">${item['Item Code']}</span>
                        </td>
                        <td class="p-3 text-gray-600 dark:text-gray-300 font-medium leading-normal">${item['Description']}</td>
                        <td class="p-3">
                            <span class="bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider group-hover:bg-white dark:group-hover:bg-gray-700 group-hover:shadow-sm">${item['Location']}</span>
                        </td>
                        <td class="p-3 text-center">
                            <button onclick="copyToClipboard('${item['Item Code']}')" class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-100 dark:hover:bg-red-900/30 rounded-md transition-all">
                                <i data-lucide="copy" class="w-4 h-4"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                lucide.createIcons();
            }
        }

        // --- Analysis Visualizer ---
        function updateAnalysisUI(q, topResult) {
            const bar = document.getElementById('analysis-bar');
            const content = document.getElementById('analysis-content');
            bar.classList.remove('hidden');
            
            const rawTokens = q.raw.split(' ').filter(x => x.length > 0);
            
            let html = '';
            
            // Show Export Tag if query has EXPLICIT Export request
            if(q.hasExplicitExp) {
                html += `<span class="badge-base badge-exp"><i data-lucide="globe" class="w-3 h-3"></i>EXPORT</span>`;
            }

            rawTokens.forEach(token => {
                let status = 'badge-skip'; // Default
                
                // If matched text
                if(topResult && topResult._searchStr.includes(token)) {
                    status = 'badge-match';
                }
                // Check Compressed Match (NEW - handles "F70S6" vs "F 70 S6")
                else if (topResult && topResult._compressedStr && topResult._compressedStr.includes(token)) {
                    status = 'badge-comp'; // Badge for Compressed Match
                }
                else if (topResult && q.packings.length > 0 && q.packings.some(p => p.toLowerCase() === token)) {
                    status = 'badge-pack';
                }
                else if (topResult && q.dims.length > 0 && isDimMatch(token, q.dims, topResult)) {
                    status = 'badge-dim';
                }
                else if (topResult && q.weights.length > 0 && isWeightMatch(token, q.weights, topResult)) {
                    status = 'badge-weight';
                }
                
                // Only show badge if NOT skipped, unless user wants to see skipped too? 
                // The prompt says "hide junk words". So we only append if status != badge-skip
                
                // Special Rule for ignoring unit-only tokens in weights to avoid "KG" being a separate green badge
                // if it's already shown in the purple weight badge
                if(['kg','kgs','mm'].includes(token)) {
                    // Do nothing (skip rendering standalone unit)
                } 
                else if(status !== 'badge-skip') {
                    // Map status to icon
                    let icon = 'check';
                    if(status === 'badge-dim') icon = 'ruler';
                    if(status === 'badge-weight') icon = 'scale';
                    if(status === 'badge-pack') icon = 'package';
                    
                    html += `<span class="badge-base ${status}"><i data-lucide="${icon}" class="w-3 h-3"></i>${token.toUpperCase()}</span>`;
                }
            });
            
            content.innerHTML = html;
            lucide.createIcons(); 
        }

        function isDimMatch(token, qDims, item) {
            const val = parseFloat(token);
            if(isNaN(val)) return false;
            return item._dims.some(d => (d.d1 === val || d.d2 === val));
        }

        function isWeightMatch(token, qWeights, item) {
            const val = parseFloat(token);
            if(isNaN(val)) return false;
            return item._weights.some(w => w === val);
        }


        // --- Bulk System ---
        async function processBulk() {
            const raw = document.getElementById('bulk-input').value;
            if(!raw.trim()) return showToast("Please paste or upload query data first");

            const btnText = document.getElementById('bulk-btn-text');
            const loader = document.getElementById('bulk-loader');
            const icon = document.getElementById('play-icon');
            const tbody = document.getElementById('bulk-table-body');
            const empty = document.getElementById('bulk-empty');
            
            btnText.textContent = "Processing...";
            icon.classList.add('hidden');
            loader.classList.remove('hidden');
            empty.classList.add('hidden');
            
            await new Promise(r => setTimeout(r, 100)); // UI Breath

            const lines = raw.split(/\r?\n/).filter(line => line.trim().length > 0);
            
            bulkResults = lines.map(line => {
                const queryInfo = parseQuery(line);
                let bestMatch = null;
                let bestScore = 0;
                
                for(const item of inventoryData) {
                    const score = calculateScore(item, queryInfo);
                    if(score > bestScore) { bestScore = score; bestMatch = item; }
                }
                return { query: line, match: bestMatch, score: bestScore };
            });

            tbody.innerHTML = '';
            bulkResults.forEach(res => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-50 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50';
                
                let confBadge = '';
                if(res.score > 40) confBadge = '<span class="text-green-600 dark:text-green-400 font-bold">High</span>';
                else if(res.score > 20) confBadge = '<span class="text-orange-500 font-medium">Med</span>';
                else confBadge = '<span class="text-red-400">Low</span>';
                
                tr.innerHTML = `
                    <td class="p-3 pl-5 text-gray-500 dark:text-gray-400 font-mono truncate max-w-xs" title="${res.query}">${res.query}</td>
                    <td class="p-3">
                         <span class="font-mono font-semibold text-gray-800 dark:text-gray-200 bg-gray-50 dark:bg-gray-700 px-1.5 py-0.5 rounded border border-gray-200 dark:border-gray-600 text-[11px]">${res.match ? res.match['Item Code'] : '-'}</span>
                    </td>
                    <td class="p-3 text-gray-700 dark:text-gray-300">${res.match ? res.match['Description'] : '<span class="italic text-gray-300 dark:text-gray-600">No Match</span>'}</td>
                    <td class="p-3 text-center text-[10px] uppercase">${confBadge}</td>
                `;
                tbody.appendChild(tr);
            });

            btnText.textContent = "Start Matching";
            loader.classList.add('hidden');
            icon.classList.remove('hidden');
        }

        function exportBulk() {
            if(bulkResults.length === 0) return showToast("No results to export");
            const data = bulkResults.map(r => ({
                "Query": r.query,
                "Code": r.match ? r.match['Item Code'] : "",
                "Description": r.match ? r.match['Description'] : "No Match Found",
                "Location": r.match ? r.match['Location'] : "",
                "Score": r.score
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Matches");
            XLSX.writeFile(wb, "Dayita_Report.xlsx");
        }

        // --- Algorithm Logic ---
        function parseQuery(str) {
            const raw = normalize(str);
            const terms = raw.split(' ').filter(x => x.length > 0);
            const dims = extractDimensions(str);
            const weights = extractWeights(str);
            const packings = extractPacking(str);
            const hasExplicitExp = terms.some(t => t === 'exp' || t === 'export');
            return { raw, terms, dims, weights, packings, hasExplicitExp, hasTerms: terms.length > 0 };
        }

        function calculateScore(item, q) {
            let score = 0;
            const itemText = item._searchStr;

            // 1. Dimensions (Highest Priority)
            if(q.dims.length > 0 && item._dims.length > 0) {
                for(let qd of q.dims) {
                    const match = item._dims.some(id => 
                        (id.type === 'rod' && qd.type === 'rod' && id.d1 === qd.d1 && id.d2 === qd.d2) ||
                        (id.type === 'single' && id.d1 === qd.d1)
                    );
                    if(match) score += 40;
                }
            }

            // 2. Weights
            if(q.weights.length > 0) {
                if(q.weights.some(qw => item._weights.some(iw => Math.abs(iw - qw) < 0.1))) score += 20;
            }

            // 3. Text Matching (UPDATED: Priority for Whole Word Matches)
            q.terms.forEach(term => { 
                // Check Whole Word (High Priority)
                const regex = new RegExp(`\\b${term}\\b`, 'i');
                if(regex.test(itemText)) {
                    score += 30; // Boost whole word matches (like "602")
                }
                // Check Substring (Low Priority)
                else if(itemText.includes(term)) {
                    score += 2; // Reduced from 10 to avoid noise matching IDs like 0026020
                }
                // NEW: Compressed Match Check (For "F70S6" matching "F 70 S6")
                else if (item._compressedStr && item._compressedStr.includes(term)) {
                    score += 40; // Extremely high confidence boost for code match
                }
            });
            
            // 4. Packing Logic
            if(q.packings.length > 0 && item._packings.length > 0) {
                const pMatch = q.packings.some(qp => item._packings.includes(qp));
                if(pMatch) score += 25;
            }

            // 5. Export Logic
            if(item._isExp) {
                score += 5; 
                if(q.hasExplicitExp) score += 20; 
            }

            // 6. Specialty Penalty
            const specialTokens = ['spl', 'mod', 'h4r', 'nace', '-l'];
            const queryHasSpecial = specialTokens.some(t => q.terms.includes(t));
            
            if (!queryHasSpecial) {
                specialTokens.forEach(token => {
                    if (item._searchStr.includes(" " + token + " ") || item._searchStr.endsWith(" " + token) || item._searchStr.startsWith(token + " ")) {
                        score -= 10; 
                    }
                });
            }

            return score;
        }

        function extractDimensions(str) {
            if (!str) return [];
            const text = str.toLowerCase();
            const res = [];
            let match;
            const rodRegex = /(\d+\.?\d*)\s*[xX*]\s*(\d+)/g;
            while ((match = rodRegex.exec(text)) !== null) {
                res.push({ type: 'rod', d1: parseFloat(match[1]), d2: parseFloat(match[2]), raw: match[0] });
            }
            const mmRegex = /(\d+\.?\d*)\s*mm\b/g;
            while ((match = mmRegex.exec(text)) !== null) {
                res.push({ type: 'single', d1: parseFloat(match[1]), raw: match[0] });
            }
            return res;
        }

        function extractWeights(str) {
            if(!str) return [];
            const res = [];
            const regex = /(\d+(\.\d+)?)\s*(?:kgs?|kg|lbs?)\b/gi;
            let match;
            while((match = regex.exec(str)) !== null) res.push(parseFloat(match[1]));
            return res;
        }

        function extractPacking(str) {
            if(!str) return [];
            const text = str.toLowerCase();
            const packs = [];
            
            if(/\b(vp|vacuum|vac)\b/.test(text)) packs.push("vp");
            if(/\b(reg|regular|std)\b/.test(text)) packs.push("reg");
            if(/\b(hdpe)\b/.test(text)) packs.push("hdpe");
            
            return packs;
        }

        function normalize(str) { return str.toLowerCase().replace(/[^a-z0-9.]/g, " ").replace(/\s+/g, " "); }

        // --- Utils ---
        function switchTab(tab) {
            document.getElementById('tab-search').classList.add('hidden');
            document.getElementById('tab-bulk').classList.add('hidden');
            document.getElementById('tab-btn-search').classList.remove('text-red-600', 'border-red-600', 'dark:text-red-400');
            document.getElementById('tab-btn-bulk').classList.remove('text-red-600', 'border-red-600', 'dark:text-red-400');
            
            const inactiveClass = ['text-gray-500', 'border-transparent', 'dark:text-gray-400'];
            document.getElementById('tab-btn-search').classList.add(...inactiveClass);
            document.getElementById('tab-btn-bulk').classList.add(...inactiveClass);
            
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            const btn = document.getElementById(`tab-btn-${tab}`);
            btn.classList.remove(...inactiveClass);
            btn.classList.add('text-red-600', 'border-red-600', 'dark:text-red-400');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            showToast(`Code Copied: ${text}`);
        }

        function showToast(msg) {
            const el = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            el.classList.remove('translate-y-32');
            setTimeout(() => el.classList.add('translate-y-32'), 2500);
        }
    </script>
</body>
</html>