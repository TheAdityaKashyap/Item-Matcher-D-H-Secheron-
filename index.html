<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dayita - Item Matcher</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS for reading Excel/CSV files -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .drag-active {
            border-color: #dc2626; /* Red-600 */
            background-color: #fef2f2; /* Red-50 */
        }
        /* Simple toast animation */
        @keyframes fade-in-out {
            0% { opacity: 0; transform: translateY(20px); }
            10% { opacity: 1; transform: translateY(0); }
            90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .toast {
            animation: fade-in-out 2s forwards;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-800 relative">

    <!-- Header (D&H Red Theme) -->
    <header class="bg-[#d32f2f] text-white shadow-md sticky top-0 z-10 border-b-4 border-gray-800">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-white p-1.5 rounded text-[#d32f2f]">
                    <i data-lucide="shield-check" class="w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight uppercase">Dayita</h1>
                    <p class="text-xs text-red-100 font-medium tracking-wide">Item Matcher for D & H Secheron</p>
                </div>
            </div>
            <div class="text-sm opacity-90 hidden sm:block font-medium">Internal Inventory Tool</div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">

        <!-- File Upload Section -->
        <div id="upload-section" class="bg-white rounded-lg shadow-sm border-2 border-dashed border-gray-300 p-12 text-center transition-all duration-200 hover:border-red-300">
            <div class="flex flex-col items-center gap-5">
                <div class="p-5 bg-red-50 rounded-full text-[#d32f2f]">
                    <i data-lucide="file-spreadsheet" class="w-10 h-10"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-gray-800">Upload Master Inventory</h2>
                    <p class="text-gray-500 mt-2 max-w-md mx-auto">Drag and drop your <strong>.xlsx</strong> or <strong>.csv</strong> file here to begin searching.</p>
                </div>
                
                <input type="file" id="file-input" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" class="hidden" />
                
                <button onclick="document.getElementById('file-input').click()" class="mt-2 px-8 py-3 bg-[#d32f2f] hover:bg-red-700 text-white font-semibold rounded shadow-sm transition-colors uppercase text-sm tracking-wider">
                    Select File
                </button>
            </div>
        </div>

        <!-- Search & Data Section (Hidden initially) -->
        <div id="data-section" class="hidden space-y-6">
            
            <!-- Search Bar -->
            <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col md:flex-row gap-4 items-center sticky top-24 z-20">
                <div class="relative flex-grow w-full">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                    <input type="text" id="search-input" placeholder="Search item, size, brand (e.g., 'Secheron 308L' or '5.00X450')" 
                        class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-300 rounded focus:ring-2 focus:ring-[#d32f2f] focus:border-[#d32f2f] outline-none transition-all placeholder-gray-500 text-gray-800"
                        autocomplete="off">
                </div>
                
                <div class="flex items-center gap-3 w-full md:w-auto flex-wrap md:flex-nowrap">
                    <div class="px-4 py-2 bg-gray-100 rounded border border-gray-200 text-sm text-gray-600 font-semibold whitespace-nowrap">
                        <span id="result-count" class="text-[#d32f2f]">0</span> Matches
                    </div>
                    
                    <button onclick="downloadResults()" class="flex items-center gap-2 px-5 py-2.5 bg-gray-800 hover:bg-black text-white text-sm font-semibold rounded transition-colors whitespace-nowrap shadow-sm">
                        <i data-lucide="download" class="w-4 h-4"></i> Export Excel
                    </button>

                    <button onclick="resetApp()" class="px-5 py-2.5 text-[#d32f2f] border border-[#d32f2f] hover:bg-red-50 text-sm font-semibold rounded transition-colors whitespace-nowrap">
                        Reset
                    </button>
                </div>
            </div>

            <!-- Results Table -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-100 border-b border-gray-200">
                            <tr>
                                <th class="p-4 font-bold text-gray-700 text-sm w-40 uppercase tracking-wider">Item Code</th>
                                <th class="p-4 font-bold text-gray-700 text-sm uppercase tracking-wider">Description</th>
                                <th class="p-4 font-bold text-gray-700 text-sm w-32 uppercase tracking-wider">Location</th>
                                <th class="p-4 font-bold text-gray-700 text-sm w-40 uppercase tracking-wider">Pack Size</th>
                                <th class="p-4 font-bold text-gray-700 text-sm w-36 uppercase tracking-wider">Updated</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="divide-y divide-gray-100 text-sm text-gray-700">
                            <!-- Rows injected here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Empty State -->
                <div id="empty-state" class="hidden p-16 text-center text-gray-500">
                    <i data-lucide="package-search" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                    <p class="text-lg font-medium">No inventory items found.</p>
                    <p class="text-sm">Try adjusting your search terms.</p>
                </div>
            </div>
        </div>

    </main>
    
    <!-- Copy Toast Notification -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 pointer-events-none"></div>

    <!-- Footer -->
    <footer class="text-center py-6 text-xs text-gray-400">
        &copy; <span id="year"></span> Dayita Inventory System. Designed for D & H Secheron.
    </footer>

    <script>
        document.getElementById('year').textContent = new Date().getFullYear();

        // --- State Management ---
        let inventoryData = [];
        let filteredData = []; // Store currently visible data for export
        const uploadSection = document.getElementById('upload-section');
        const dataSection = document.getElementById('data-section');
        const fileInput = document.getElementById('file-input');
        const searchInput = document.getElementById('search-input');
        const tableBody = document.getElementById('table-body');
        const resultCount = document.getElementById('result-count');
        const emptyState = document.getElementById('empty-state');
        const toastContainer = document.getElementById('toast-container');

        // --- Icon Setup ---
        lucide.createIcons();

        // --- Event Listeners ---
        
        // Drag & Drop
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('drag-active');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('drag-active');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('drag-active');
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length) {
                handleFile(e.target.files[0]);
            }
        });

        // Search Input
        searchInput.addEventListener('input', (e) => {
            renderTable(e.target.value);
        });

        // --- Core Functions ---

        function handleFile(file) {
            const reader = new FileReader();

            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // Assuming first sheet is the one we want
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                if (jsonData.length > 0) {
                    inventoryData = jsonData;
                    filteredData = jsonData; // Initialize filtered with all
                    showDataUI();
                    renderTable();
                } else {
                    alert("The file appears to be empty or unreadable.");
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function showDataUI() {
            uploadSection.classList.add('hidden');
            dataSection.classList.remove('hidden');
            searchInput.focus();
        }

        function resetApp() {
            inventoryData = [];
            filteredData = [];
            fileInput.value = '';
            searchInput.value = '';
            uploadSection.classList.remove('hidden');
            dataSection.classList.add('hidden');
        }

        function renderTable(searchTerm = "") {
            tableBody.innerHTML = "";
            const rawTerms = searchTerm.toLowerCase().split(" ").filter(t => t.length > 0);
            
            // Helper: normalize string
            const normalize = (str) => str.toLowerCase().replace(/[^a-z0-9.]/g, "");

            filteredData = inventoryData.filter(item => {
                if (rawTerms.length === 0) return true;

                const originalString = `
                    ${item['Item Code'] || ''} 
                    ${item['Description'] || ''} 
                    ${item['Location'] || ''} 
                    ${item['Pack Size'] || ''}
                `.toLowerCase();

                const smartString = normalize(originalString);

                return rawTerms.every(term => {
                    const cleanTerm = normalize(term);
                    return originalString.includes(term) || (cleanTerm.length > 0 && smartString.includes(cleanTerm));
                });
            });

            resultCount.textContent = filteredData.length;

            if (filteredData.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            } else {
                emptyState.classList.add('hidden');
            }

            // Render Rows (Limit to 100 for performance if query is empty)
            const displayLimit = searchTerm === "" ? 100 : 500;
            
            filteredData.slice(0, displayLimit).forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-red-50 transition-colors group border-b border-gray-100 last:border-0";
                
                const itemCode = item['Item Code'] || '-';
                
                tr.innerHTML = `
                    <td class="p-4">
                        <div class="flex items-center gap-2">
                            <span class="font-mono text-xs font-bold text-[#d32f2f] bg-red-50 px-2 py-1 rounded">${itemCode}</span>
                            <button onclick="copyToClipboard('${itemCode}')" class="opacity-0 group-hover:opacity-100 transition-opacity text-gray-400 hover:text-[#d32f2f] p-1" title="Copy Item Code">
                                <i data-lucide="copy" class="w-3 h-3"></i>
                            </button>
                        </div>
                    </td>
                    <td class="p-4 font-medium text-gray-800">${item['Description'] || '-'}</td>
                    <td class="p-4">
                        <span class="inline-flex items-center px-2.5 py-1 rounded text-xs font-bold bg-gray-200 text-gray-700">
                            ${item['Location'] || '-'}
                        </span>
                    </td>
                    <td class="p-4 text-gray-600">${item['Pack Size'] || '-'}</td>
                    <td class="p-4 text-gray-400 text-xs">${item['Date updated'] || '-'}</td>
                `;
                tableBody.appendChild(tr);
            });
            lucide.createIcons();
        }

        // --- Export Feature ---
        function downloadResults() {
            if (filteredData.length === 0) {
                alert("No data to export!");
                return;
            }
            const worksheet = XLSX.utils.json_to_sheet(filteredData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "SearchResults");
            XLSX.writeFile(workbook, "Dayita_SearchResults.xlsx");
        }

        // --- Copy Feature ---
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast(`Copied: ${text}`);
            });
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = "toast bg-gray-900 text-white px-5 py-3 rounded shadow-xl text-sm mb-2 flex items-center gap-2 border-l-4 border-[#d32f2f]";
            toast.innerHTML = `<i data-lucide="check" class="w-4 h-4 text-green-400"></i> ${message}`;
            toastContainer.appendChild(toast);
            lucide.createIcons();
            
            // Auto remove after animation ends (2s)
            setTimeout(() => {
                toast.remove();
            }, 2000);
        }
    </script>
</body>
</html>
